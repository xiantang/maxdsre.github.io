<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>xiantang </title>
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="generator" content="Hugo 0.63.0-DEV" />
    
    
      <META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">
    

    
    
      <link href="/dist/css/app.3f5912c237ddd38c8e76debe081c7ca7.css" rel="stylesheet">
    

    

    
      
    

    
    
    <meta property="og:title" content="" />
<meta property="og:description" content="1.step1-最基本的容器 IoC最基本的角色有两个：容器(BeanFactory)和Bean本身。这里使用BeanDefinition来封装了bean对象，这样可以保存一些额外的元信息。测试代码：
// 1.初始化beanfactory BeanFactory beanFactory = new BeanFactory(); // 2.注入bean BeanDefinition beanDefinition = new BeanDefinition(new HelloWorldService()); beanFactory.registerBeanDefinition(&#34;helloWorldService&#34;, beanDefinition); // 3.获取bean HelloWorldService helloWorldService = (HelloWorldService) beanFactory.getBean(&#34;helloWorldService&#34;); helloWorldService.helloWorld(); 对于 BeanFactory 我们使用的容器是 ConcurrentHashMap
public class BeanFactory { /** * Spring 通过线程池的方式来publishEvent ApplicationListener的实现类是在线程中运行的 */ private Map&lt;String, BeanDefinition&gt; beanDefinitionMap = new ConcurrentHashMap&lt;&gt;(); public Object getBean(String name){ return beanDefinitionMap.get(name).getBean(); } public void registerBeanDefinition(String name, BeanDefinition beanDefinition) { beanDefinitionMap.put(name, beanDefinition); } } 2.step2-将bean创建放入工厂 step1中的bean是初始化好之后再set进去的，实际使用中，我们希望容器来管理bean的创建。于是我们将bean的初始化放入BeanFactory中。为了保证扩展性，我们使用Extract Interface的方法，将BeanFactory替换成接口，而使用AbstractBeanFactory和AutowireCapableBeanFactory作为其实现。&ldquo;AutowireCapable&quot;的意思是“可自动装配的”，为我们后面注入属性做准备。
// 1." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://xiantang.github.io/framework%E6%A1%86%E6%9E%B6/spring/" />

<meta itemprop="name" content="">
<meta itemprop="description" content="1.step1-最基本的容器 IoC最基本的角色有两个：容器(BeanFactory)和Bean本身。这里使用BeanDefinition来封装了bean对象，这样可以保存一些额外的元信息。测试代码：
// 1.初始化beanfactory BeanFactory beanFactory = new BeanFactory(); // 2.注入bean BeanDefinition beanDefinition = new BeanDefinition(new HelloWorldService()); beanFactory.registerBeanDefinition(&#34;helloWorldService&#34;, beanDefinition); // 3.获取bean HelloWorldService helloWorldService = (HelloWorldService) beanFactory.getBean(&#34;helloWorldService&#34;); helloWorldService.helloWorld(); 对于 BeanFactory 我们使用的容器是 ConcurrentHashMap
public class BeanFactory { /** * Spring 通过线程池的方式来publishEvent ApplicationListener的实现类是在线程中运行的 */ private Map&lt;String, BeanDefinition&gt; beanDefinitionMap = new ConcurrentHashMap&lt;&gt;(); public Object getBean(String name){ return beanDefinitionMap.get(name).getBean(); } public void registerBeanDefinition(String name, BeanDefinition beanDefinition) { beanDefinitionMap.put(name, beanDefinition); } } 2.step2-将bean创建放入工厂 step1中的bean是初始化好之后再set进去的，实际使用中，我们希望容器来管理bean的创建。于是我们将bean的初始化放入BeanFactory中。为了保证扩展性，我们使用Extract Interface的方法，将BeanFactory替换成接口，而使用AbstractBeanFactory和AutowireCapableBeanFactory作为其实现。&ldquo;AutowireCapable&quot;的意思是“可自动装配的”，为我们后面注入属性做准备。
// 1.">

<meta itemprop="wordCount" content="428">



<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content=""/>
<meta name="twitter:description" content="1.step1-最基本的容器 IoC最基本的角色有两个：容器(BeanFactory)和Bean本身。这里使用BeanDefinition来封装了bean对象，这样可以保存一些额外的元信息。测试代码：
// 1.初始化beanfactory BeanFactory beanFactory = new BeanFactory(); // 2.注入bean BeanDefinition beanDefinition = new BeanDefinition(new HelloWorldService()); beanFactory.registerBeanDefinition(&#34;helloWorldService&#34;, beanDefinition); // 3.获取bean HelloWorldService helloWorldService = (HelloWorldService) beanFactory.getBean(&#34;helloWorldService&#34;); helloWorldService.helloWorld(); 对于 BeanFactory 我们使用的容器是 ConcurrentHashMap
public class BeanFactory { /** * Spring 通过线程池的方式来publishEvent ApplicationListener的实现类是在线程中运行的 */ private Map&lt;String, BeanDefinition&gt; beanDefinitionMap = new ConcurrentHashMap&lt;&gt;(); public Object getBean(String name){ return beanDefinitionMap.get(name).getBean(); } public void registerBeanDefinition(String name, BeanDefinition beanDefinition) { beanDefinitionMap.put(name, beanDefinition); } } 2.step2-将bean创建放入工厂 step1中的bean是初始化好之后再set进去的，实际使用中，我们希望容器来管理bean的创建。于是我们将bean的初始化放入BeanFactory中。为了保证扩展性，我们使用Extract Interface的方法，将BeanFactory替换成接口，而使用AbstractBeanFactory和AutowireCapableBeanFactory作为其实现。&ldquo;AutowireCapable&quot;的意思是“可自动装配的”，为我们后面注入属性做准备。
// 1."/>

  </head>

  <body class="ma0 avenir bg-near-white">

    
   
  

  <header>
    <div class="bg-black">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="https://xiantang.github.io/" class="f3 fw2 hover-white no-underline white-90 dib">
      xiantang
    </a>
    <div class="flex-l items-center">
      

      
      













    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  
  <article class="flex-l flex-wrap justify-between mw8 center ph3">

    <header class="mt4 w-100">
      <p class="f6 b helvetica tracked">
          
        FRAMEWORK(框架)S
      </p>
      <h1 class="f1 athelas mb1"></h1>
      
      
      <time class="f6 mv4 dib tracked" datetime="0001-01-01T00:00:00Z">January 1, 0001</time>
      
      
    </header>

    <section class="nested-copy-line-height lh-copy serif f4 nested-links nested-img mid-gray pr4-l w-two-thirds-l"><h2 id="1step1-最基本的容器">1.step1-最基本的容器</h2>
<p>IoC最基本的角色有两个：容器(<code>BeanFactory</code>)和Bean本身。这里使用<code>BeanDefinition</code>来封装了bean对象，这样可以保存一些额外的元信息。测试代码：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">// 1.初始化beanfactory
</span><span style="color:#75715e"></span>BeanFactory beanFactory <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> BeanFactory<span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>

<span style="color:#75715e">// 2.注入bean
</span><span style="color:#75715e"></span>BeanDefinition beanDefinition <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> BeanDefinition<span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> HelloWorldService<span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
beanFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">registerBeanDefinition</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;helloWorldService&#34;</span><span style="color:#f92672">,</span> beanDefinition<span style="color:#f92672">)</span><span style="color:#f92672">;</span>

<span style="color:#75715e">// 3.获取bean
</span><span style="color:#75715e"></span>HelloWorldService helloWorldService <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>HelloWorldService<span style="color:#f92672">)</span> beanFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">getBean</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;helloWorldService&#34;</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
helloWorldService<span style="color:#f92672">.</span><span style="color:#a6e22e">helloWorld</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
</code></pre></div><p>对于 <code>BeanFactory</code> 我们使用的容器是 <code>ConcurrentHashMap</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">BeanFactory</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">/**
</span><span style="color:#75715e">     * Spring 通过线程池的方式来publishEvent ApplicationListener的实现类是在线程中运行的
</span><span style="color:#75715e">     */</span>
    <span style="color:#66d9ef">private</span> Map<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> BeanDefinition<span style="color:#f92672">&gt;</span> beanDefinitionMap <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ConcurrentHashMap<span style="color:#f92672">&lt;</span><span style="color:#f92672">&gt;</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>

    <span style="color:#66d9ef">public</span> Object <span style="color:#a6e22e">getBean</span><span style="color:#f92672">(</span>String name<span style="color:#f92672">)</span><span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> beanDefinitionMap<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>name<span style="color:#f92672">)</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getBean</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">registerBeanDefinition</span><span style="color:#f92672">(</span>String name<span style="color:#f92672">,</span> BeanDefinition beanDefinition<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        beanDefinitionMap<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span>name<span style="color:#f92672">,</span> beanDefinition<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

<span style="color:#f92672">}</span>

</code></pre></div><h2 id="2step2-将bean创建放入工厂">2.step2-将bean创建放入工厂</h2>
<p>step1中的bean是初始化好之后再set进去的，实际使用中，我们希望容器来管理bean的创建。于是我们将bean的初始化放入BeanFactory中。为了保证扩展性，我们使用Extract Interface的方法，将<code>BeanFactory</code>替换成接口，而使用<code>AbstractBeanFactory</code>和<code>AutowireCapableBeanFactory</code>作为其实现。&ldquo;AutowireCapable&quot;的意思是“可自动装配的”，为我们后面注入属性做准备。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"> <span style="color:#75715e">// 1.初始化beanfactory
</span><span style="color:#75715e"></span>BeanFactory beanFactory <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> AutowireCapableBeanFactory<span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>

<span style="color:#75715e">// 2.注入bean
</span><span style="color:#75715e"></span>BeanDefinition beanDefinition <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> BeanDefinition<span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
beanDefinition<span style="color:#f92672">.</span><span style="color:#a6e22e">setBeanClassName</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;us.codecraft.tinyioc.HelloWorldService&#34;</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
beanFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">registerBeanDefinition</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;helloWorldService&#34;</span><span style="color:#f92672">,</span> beanDefinition<span style="color:#f92672">)</span><span style="color:#f92672">;</span>

<span style="color:#75715e">// 3.获取bean
</span><span style="color:#75715e"></span>HelloWorldService helloWorldService <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>HelloWorldService<span style="color:#f92672">)</span> beanFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">getBean</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;helloWorldService&#34;</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
helloWorldService<span style="color:#f92672">.</span><span style="color:#a6e22e">helloWorld</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
</code></pre></div><h2 id="3step3-为bean注入属性">3.step3-为bean注入属性</h2>
<p>这一步，我们想要为bean注入属性。我们选择将属性注入信息保存成<code>PropertyValue</code>对象，并且保存到<code>BeanDefinition</code>中。这样在初始化bean的时候，我们就可以根据PropertyValue来进行bean属性的注入。Spring本身使用了setter来进行注入，这里为了代码简洁，我们使用Field的形式来注入。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">// 1.初始化beanfactory
</span><span style="color:#75715e"></span>BeanFactory beanFactory <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> AutowireCapableBeanFactory<span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>

<span style="color:#75715e">// 2.bean定义
</span><span style="color:#75715e"></span>BeanDefinition beanDefinition <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> BeanDefinition<span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
beanDefinition<span style="color:#f92672">.</span><span style="color:#a6e22e">setBeanClassName</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;us.codecraft.tinyioc.HelloWorldService&#34;</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>

<span style="color:#75715e">// 3.设置属性
</span><span style="color:#75715e"></span>PropertyValues propertyValues <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> PropertyValues<span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
propertyValues<span style="color:#f92672">.</span><span style="color:#a6e22e">addPropertyValue</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> PropertyValue<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;text&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Hello World!&#34;</span><span style="color:#f92672">)</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
beanDefinition<span style="color:#f92672">.</span><span style="color:#a6e22e">setPropertyValues</span><span style="color:#f92672">(</span>propertyValues<span style="color:#f92672">)</span><span style="color:#f92672">;</span>

<span style="color:#75715e">// 4.生成bean
</span><span style="color:#75715e"></span>beanFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">registerBeanDefinition</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;helloWorldService&#34;</span><span style="color:#f92672">,</span> beanDefinition<span style="color:#f92672">)</span><span style="color:#f92672">;</span>

<span style="color:#75715e">// 5.获取bean
</span><span style="color:#75715e"></span>HelloWorldService helloWorldService <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>HelloWorldService<span style="color:#f92672">)</span> beanFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">getBean</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;helloWorldService&#34;</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
helloWorldService<span style="color:#f92672">.</span><span style="color:#a6e22e">helloWorld</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
</code></pre></div><p>这里最重要的实现是</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">applyPropertyValues</span><span style="color:#f92672">(</span>Object bean<span style="color:#f92672">,</span>BeanDefinition mbd<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span>  Exception <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>PropertyValue propertyValue <span style="color:#f92672">:</span> mbd<span style="color:#f92672">.</span><span style="color:#a6e22e">getPropertyValues</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getPropertyValues</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            Field declareField <span style="color:#f92672">=</span> bean<span style="color:#f92672">.</span><span style="color:#a6e22e">getClass</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getDeclaredField</span><span style="color:#f92672">(</span>propertyValue<span style="color:#f92672">.</span><span style="color:#a6e22e">getName</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
            declareField<span style="color:#f92672">.</span><span style="color:#a6e22e">setAccessible</span><span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
            declareField<span style="color:#f92672">.</span><span style="color:#a6e22e">set</span><span style="color:#f92672">(</span>bean<span style="color:#f92672">,</span> propertyValue<span style="color:#f92672">.</span><span style="color:#a6e22e">getValue</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
</code></pre></div><p>从这个 <code>PropertyValues</code> 遍历所有元素,先使用反射创建实例，然后获取他的域并且设置新的值。</p>
<h2 id="4step4-读取xml配置来初始化bean">4.step4-读取xml配置来初始化bean</h2>
<pre><code>git checkout step-4-config-beanfactory-with-xml
</code></pre><p>这么大一坨初始化代码让人心烦。这里的<code>BeanDefinition</code>只是一些配置，我们还是用xml来初始化吧。我们定义了<code>BeanDefinitionReader</code>初始化bean，它有一个实现是<code>XmlBeanDefinitionReader</code>。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">// 1.读取配置
</span><span style="color:#75715e"></span>XmlBeanDefinitionReader xmlBeanDefinitionReader <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> XmlBeanDefinitionReader<span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> ResourceLoader<span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
xmlBeanDefinitionReader<span style="color:#f92672">.</span><span style="color:#a6e22e">loadBeanDefinitions</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;tinyioc.xml&#34;</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>

<span style="color:#75715e">// 2.初始化BeanFactory并注册bean
</span><span style="color:#75715e"></span>BeanFactory beanFactory <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> AutowireCapableBeanFactory<span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
<span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>Map<span style="color:#f92672">.</span><span style="color:#a6e22e">Entry</span><span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> BeanDefinition<span style="color:#f92672">&gt;</span> beanDefinitionEntry <span style="color:#f92672">:</span> xmlBeanDefinitionReader<span style="color:#f92672">.</span><span style="color:#a6e22e">getRegistry</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">.</span><span style="color:#a6e22e">entrySet</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        beanFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">registerBeanDefinition</span><span style="color:#f92672">(</span>beanDefinitionEntry<span style="color:#f92672">.</span><span style="color:#a6e22e">getKey</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">,</span> beanDefinitionEntry<span style="color:#f92672">.</span><span style="color:#a6e22e">getValue</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>

<span style="color:#75715e">// 3.获取bean
</span><span style="color:#75715e"></span>HelloWorldService helloWorldService <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>HelloWorldService<span style="color:#f92672">)</span> beanFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">getBean</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;helloWorldService&#34;</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
helloWorldService<span style="color:#f92672">.</span><span style="color:#a6e22e">helloWorld</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
</code></pre></div><h2 id="5step5-为bean注入bean">5.step5-为bean注入bean</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">git checkout step-5-inject-bean-to-bean
</code></pre></div><p>使用xml配置之后，似乎里我们熟知的Spring更近了一步！但是现在有一个大问题没有解决：我们无法处理bean之间的依赖，无法将bean注入到bean中，所以它无法称之为完整的IoC容器！如何实现呢？我们定义一个<code>BeanReference</code>，来表示这个属性是对另一个bean的引用。这个在读取xml的时候初始化，并在初始化bean的时候，进行解析和真实bean的注入。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>PropertyValue propertyValue <span style="color:#f92672">:</span> mbd<span style="color:#f92672">.</span><span style="color:#a6e22e">getPropertyValues</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getPropertyValues</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    Field declaredField <span style="color:#f92672">=</span> bean<span style="color:#f92672">.</span><span style="color:#a6e22e">getClass</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getDeclaredField</span><span style="color:#f92672">(</span>propertyValue<span style="color:#f92672">.</span><span style="color:#a6e22e">getName</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
    declaredField<span style="color:#f92672">.</span><span style="color:#a6e22e">setAccessible</span><span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
    Object value <span style="color:#f92672">=</span> propertyValue<span style="color:#f92672">.</span><span style="color:#a6e22e">getValue</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>value <span style="color:#66d9ef">instanceof</span> BeanReference<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        BeanReference beanReference <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>BeanReference<span style="color:#f92672">)</span> value<span style="color:#f92672">;</span>
        value <span style="color:#f92672">=</span> getBean<span style="color:#f92672">(</span>beanReference<span style="color:#f92672">.</span><span style="color:#a6e22e">getName</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
    declaredField<span style="color:#f92672">.</span><span style="color:#a6e22e">set</span><span style="color:#f92672">(</span>bean<span style="color:#f92672">,</span> value<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>同时为了解决循环依赖的问题，我们使用lazy-init的方式，将createBean的事情放到<code>getBean</code>的时候才执行，是不是一下子方便很多？这样在注入bean的时候，如果该属性对应的bean找不到，那么就先创建！因为总是先创建后注入，所以不会存在两个循环依赖的bean创建死锁的问题。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">// 1.读取配置
</span><span style="color:#75715e"></span>XmlBeanDefinitionReader xmlBeanDefinitionReader <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> XmlBeanDefinitionReader<span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> ResourceLoader<span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
xmlBeanDefinitionReader<span style="color:#f92672">.</span><span style="color:#a6e22e">loadBeanDefinitions</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;tinyioc.xml&#34;</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>

<span style="color:#75715e">// 2.初始化BeanFactory并注册bean
</span><span style="color:#75715e"></span>AbstractBeanFactory beanFactory <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> AutowireCapableBeanFactory<span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
<span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>Map<span style="color:#f92672">.</span><span style="color:#a6e22e">Entry</span><span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> BeanDefinition<span style="color:#f92672">&gt;</span> beanDefinitionEntry <span style="color:#f92672">:</span> xmlBeanDefinitionReader<span style="color:#f92672">.</span><span style="color:#a6e22e">getRegistry</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">.</span><span style="color:#a6e22e">entrySet</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    beanFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">registerBeanDefinition</span><span style="color:#f92672">(</span>beanDefinitionEntry<span style="color:#f92672">.</span><span style="color:#a6e22e">getKey</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">,</span> beanDefinitionEntry<span style="color:#f92672">.</span><span style="color:#a6e22e">getValue</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>

<span style="color:#75715e">// 3.初始化bean
</span><span style="color:#75715e"></span>beanFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">preInstantiateSingletons</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>

<span style="color:#75715e">// 4.获取bean
</span><span style="color:#75715e"></span>HelloWorldService helloWorldService <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>HelloWorldService<span style="color:#f92672">)</span> beanFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">getBean</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;helloWorldService&#34;</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
helloWorldService<span style="color:#f92672">.</span><span style="color:#a6e22e">helloWorld</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
</code></pre></div><h2 id="6step6-applicationcontext登场">6.step6-ApplicationContext登场</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">git checkout step-6-invite-application-context
</code></pre></div><p>现在BeanFactory的功能齐全了，但是使用起来有点麻烦。于是我们引入熟悉的<code>ApplicationContext</code>接口，并在<code>AbstractApplicationContext</code>的<code>refresh()</code>方法中进行bean的初始化工作。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">ApplicationContext applicationContext <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ClassPathXmlApplicationContext<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;tinyioc.xml&#34;</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
HelloWorldService helloWorldService <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>HelloWorldService<span style="color:#f92672">)</span> applicationContext<span style="color:#f92672">.</span><span style="color:#a6e22e">getBean</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;helloWorldService&#34;</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
helloWorldService<span style="color:#f92672">.</span><span style="color:#a6e22e">helloWorld</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
</code></pre></div><p>是不是非常熟悉？至此为止，我们的tiny-spring的IoC部分可说完工了。这部分的类、方法命名和作用，都是对应Spring中相应的组件。虽然代码量只有400多行，但是已经有了基本的IoC功能！</p>
<h2 id="7step7-使用jdk动态代理实现aop织入">7.step7-使用JDK动态代理实现AOP织入</h2>
<pre><code>git checkout step-7-method-interceptor-by-jdk-dynamic-proxy
</code></pre><p>织入（weave）相对简单，我们先从它开始。Spring AOP的织入点是<code>AopProxy</code>，它包含一个方法<code>Object getProxy()</code>来获取代理后的对象。</p>
<p>在Spring AOP中，我觉得最重要的两个角色，就是我们熟悉的<code>MethodInterceptor</code>和<code>MethodInvocation</code>（这两个角色都是AOP联盟的标准），它们分别对应AOP中两个基本角色：<code>Advice</code>和<code>Joinpoint</code>。Advice定义了在切点指定的逻辑，而Joinpoint则代表切点。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">MethodInterceptor</span> <span style="color:#66d9ef">extends</span> Interceptor <span style="color:#f92672">{</span>
    Object <span style="color:#a6e22e">invoke</span><span style="color:#f92672">(</span>MethodInvocation invocation<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Throwable<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>Spring的AOP只支持方法级别的调用，所以其实在AopProxy里，我们只需要将MethodInterceptor放入对象的方法调用即可。</p>
<p>我们称被代理对象为<code>TargetSource</code>，而<code>AdvisedSupport</code>就是保存TargetSource和MethodInterceptor的元数据对象。这一步我们先实现一个基于JDK动态代理的<code>JdkDynamicAopProxy</code>，它可以对接口进行代理。于是我们就有了基本的织入功能。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">	<span style="color:#a6e22e">@Test</span>
	<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">testInterceptor</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
		<span style="color:#75715e">// --------- helloWorldService without AOP
</span><span style="color:#75715e"></span>		ApplicationContext applicationContext <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ClassPathXmlApplicationContext<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;tinyioc.xml&#34;</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
		HelloWorldService helloWorldService <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>HelloWorldService<span style="color:#f92672">)</span> applicationContext<span style="color:#f92672">.</span><span style="color:#a6e22e">getBean</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;helloWorldService&#34;</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
		helloWorldService<span style="color:#f92672">.</span><span style="color:#a6e22e">helloWorld</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>

		<span style="color:#75715e">// --------- helloWorldService with AOP
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// 1. 设置被代理对象(Joinpoint)
</span><span style="color:#75715e"></span>		AdvisedSupport advisedSupport <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> AdvisedSupport<span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
		TargetSource targetSource <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> TargetSource<span style="color:#f92672">(</span>helloWorldService<span style="color:#f92672">,</span> HelloWorldServiceImpl<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span>
				HelloWorldService<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
		advisedSupport<span style="color:#f92672">.</span><span style="color:#a6e22e">setTargetSource</span><span style="color:#f92672">(</span>targetSource<span style="color:#f92672">)</span><span style="color:#f92672">;</span>

		<span style="color:#75715e">// 2. 设置拦截器(Advice)
</span><span style="color:#75715e"></span>		TimerInterceptor timerInterceptor <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> TimerInterceptor<span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
		advisedSupport<span style="color:#f92672">.</span><span style="color:#a6e22e">setMethodInterceptor</span><span style="color:#f92672">(</span>timerInterceptor<span style="color:#f92672">)</span><span style="color:#f92672">;</span>

		<span style="color:#75715e">// 3. 创建代理(Proxy)
</span><span style="color:#75715e"></span>		JdkDynamicAopProxy jdkDynamicAopProxy <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> JdkDynamicAopProxy<span style="color:#f92672">(</span>advisedSupport<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
		HelloWorldService helloWorldServiceProxy <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>HelloWorldService<span style="color:#f92672">)</span> jdkDynamicAopProxy<span style="color:#f92672">.</span><span style="color:#a6e22e">getProxy</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>

		<span style="color:#75715e">// 4. 基于AOP的调用
</span><span style="color:#75715e"></span>		helloWorldServiceProxy<span style="color:#f92672">.</span><span style="color:#a6e22e">helloWorld</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>

	<span style="color:#f92672">}</span>
</code></pre></div><p>spring 启动流程：</p>
<pre><code>### Tomcat 启动流程
</code></pre>
<ol>
<li>
<p>解析web.xml</p>
</li>
<li>
<p>部署web.xml 由<code>&lt;listener&gt;</code>元素标记的事件监听器会被创建和初始化</p>
</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml">  <span style="color:#f92672">&lt;listener</span><span style="color:#f92672">&gt;</span>
    <span style="color:#f92672">&lt;listener-class</span><span style="color:#f92672">&gt;</span>org.springframework.web.context.ContextLoaderListener<span style="color:#f92672">&lt;/listener-class&gt;</span>
  <span style="color:#f92672">&lt;/listener&gt;</span>
</code></pre></div><ol start="3">
<li>对于所有事件监听器，如果实现了<code>ServletContextListener</code>接口，将会执行其实现的<code>contextInitialized()</code>方法</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">contextInitialized</span><span style="color:#f92672">(</span>ServletContextEvent event<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">initWebApplicationContext</span><span style="color:#f92672">(</span>event<span style="color:#f92672">.</span><span style="color:#a6e22e">getServletContext</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
</code></pre></div><ol start="4">
<li>部署描述文件中由<code>&lt;filter&gt;</code>元素标记的过滤器会被创建和初始化，并调用其<code>init()</code>方法</li>
<li>部署描述文件中由<code>&lt;servlet&gt;</code>元素标记的servlet会根据<code>&lt;load-on-startup&gt;</code>的权值按顺序创建和初始化，并调用其<code>init()</code>方法</li>
</ol>
<p><img src="https://upload-images.jianshu.io/upload_images/3132379-e00a302bf7a8e24b.jpeg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000/format/webp" alt="img"></p>
<p>首先看一下前面讲述的<code>ServletContextListener</code>接口源码:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">ServletContextListener</span> <span style="color:#66d9ef">extends</span> EventListener <span style="color:#f92672">{</span>
	<span style="color:#75715e">/**
</span><span style="color:#75715e">	实现了该接口的listener会向发布者进行订阅，当Web应用初始化或销毁时会分别调用上述两个方法。
</span><span style="color:#75715e">	**/</span>
    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">contextInitialized</span><span style="color:#f92672">(</span>ServletContextEvent var1<span style="color:#f92672">)</span><span style="color:#f92672">;</span>

    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">contextDestroyed</span><span style="color:#f92672">(</span>ServletContextEvent var1<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>

</code></pre></div><p>DispatcherServlet 怎么用：</p>
<p>为什么类加载器用组合</p>
<ul class="pa0">
  
</ul>
<div class="mt6">
      
      
      </div>
    </section>

    <aside class="w-30-l mt6-l">




</aside>

  </article>

    </main>
    <footer class="bg-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://xiantang.github.io/" >
    &copy;  xiantang 2020 
  </a>
    <div>












</div>
  </div>
</footer>

    

  <script src="/dist/js/app.3fc0f988d21662902933.js"></script>


  </body>
</html>
