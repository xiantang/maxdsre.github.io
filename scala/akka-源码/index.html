<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>xiantang </title>
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="generator" content="Hugo 0.63.0-DEV" />
    
    
      <META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">
    

    
    
      <link href="/dist/css/app.3f5912c237ddd38c8e76debe081c7ca7.css" rel="stylesheet">
    

    

    
      
    

    
    
    <meta property="og:title" content="" />
<meta property="og:description" content="object Main1 extends App { val system = ActorSystem(&#34;HelloSystem&#34;) val jazzListener = system.actorOf(Props[Listener]) val musicListener = system.actorOf(Props[Listener]) system.eventStream.subscribe(jazzListener, classOf[Jazz]) // jazzListener 订阅 Jazz 事件  system.eventStream.subscribe(musicListener, classOf[AllKindsOfMusic]) // musicListener 订阅 AllKindsOfMusic 以及它的子类 事件  // 只有 musicListener 接收到这个事件  system.eventStream.publish(Electronic(&#34;Parov Stelar&#34;)) // jazzListener 和 musicListener 都会收到这个事件  system.eventStream.publish(Jazz(&#34;Sonny Rollins&#34;)) } subscribe 逻辑 同步地将 subcriber 和 to 加入到 subscriptions 中，diff 应该是和之前的一次比较保证不会重复发送?
def subscribe(subscriber: Subscriber, to: Classifier): Boolean = subscriptions.synchronized { val diff = subscriptions." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://xiantang.github.io/scala/akka-%E6%BA%90%E7%A0%81/" />

<meta itemprop="name" content="">
<meta itemprop="description" content="object Main1 extends App { val system = ActorSystem(&#34;HelloSystem&#34;) val jazzListener = system.actorOf(Props[Listener]) val musicListener = system.actorOf(Props[Listener]) system.eventStream.subscribe(jazzListener, classOf[Jazz]) // jazzListener 订阅 Jazz 事件  system.eventStream.subscribe(musicListener, classOf[AllKindsOfMusic]) // musicListener 订阅 AllKindsOfMusic 以及它的子类 事件  // 只有 musicListener 接收到这个事件  system.eventStream.publish(Electronic(&#34;Parov Stelar&#34;)) // jazzListener 和 musicListener 都会收到这个事件  system.eventStream.publish(Jazz(&#34;Sonny Rollins&#34;)) } subscribe 逻辑 同步地将 subcriber 和 to 加入到 subscriptions 中，diff 应该是和之前的一次比较保证不会重复发送?
def subscribe(subscriber: Subscriber, to: Classifier): Boolean = subscriptions.synchronized { val diff = subscriptions.">

<meta itemprop="wordCount" content="646">



<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content=""/>
<meta name="twitter:description" content="object Main1 extends App { val system = ActorSystem(&#34;HelloSystem&#34;) val jazzListener = system.actorOf(Props[Listener]) val musicListener = system.actorOf(Props[Listener]) system.eventStream.subscribe(jazzListener, classOf[Jazz]) // jazzListener 订阅 Jazz 事件  system.eventStream.subscribe(musicListener, classOf[AllKindsOfMusic]) // musicListener 订阅 AllKindsOfMusic 以及它的子类 事件  // 只有 musicListener 接收到这个事件  system.eventStream.publish(Electronic(&#34;Parov Stelar&#34;)) // jazzListener 和 musicListener 都会收到这个事件  system.eventStream.publish(Jazz(&#34;Sonny Rollins&#34;)) } subscribe 逻辑 同步地将 subcriber 和 to 加入到 subscriptions 中，diff 应该是和之前的一次比较保证不会重复发送?
def subscribe(subscriber: Subscriber, to: Classifier): Boolean = subscriptions.synchronized { val diff = subscriptions."/>

  </head>

  <body class="ma0 avenir bg-near-white">

    
   
  

  <header>
    <div class="bg-black">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="https://xiantang.github.io/" class="f3 fw2 hover-white no-underline white-90 dib">
      xiantang
    </a>
    <div class="flex-l items-center">
      

      
      













    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  
  <article class="flex-l flex-wrap justify-between mw8 center ph3">

    <header class="mt4 w-100">
      <p class="f6 b helvetica tracked">
          
        SCALAS
      </p>
      <h1 class="f1 athelas mb1"></h1>
      
      
      <time class="f6 mv4 dib tracked" datetime="0001-01-01T00:00:00Z">January 1, 0001</time>
      
      
    </header>

    <section class="nested-copy-line-height lh-copy serif f4 nested-links nested-img mid-gray pr4-l w-two-thirds-l"><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#66d9ef">object</span> <span style="color:#a6e22e">Main1</span> <span style="color:#66d9ef">extends</span> <span style="color:#a6e22e">App</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">val</span> system <span style="color:#66d9ef">=</span> <span style="color:#a6e22e">ActorSystem</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;HelloSystem&#34;</span><span style="color:#f92672">)</span>
  <span style="color:#66d9ef">val</span> jazzListener <span style="color:#66d9ef">=</span> system<span style="color:#f92672">.</span>actorOf<span style="color:#f92672">(</span><span style="color:#a6e22e">Props</span><span style="color:#f92672">[</span><span style="color:#66d9ef">Listener</span><span style="color:#f92672">]</span><span style="color:#f92672">)</span>
  <span style="color:#66d9ef">val</span> musicListener <span style="color:#66d9ef">=</span> system<span style="color:#f92672">.</span>actorOf<span style="color:#f92672">(</span><span style="color:#a6e22e">Props</span><span style="color:#f92672">[</span><span style="color:#66d9ef">Listener</span><span style="color:#f92672">]</span><span style="color:#f92672">)</span>
  system<span style="color:#f92672">.</span>eventStream<span style="color:#f92672">.</span>subscribe<span style="color:#f92672">(</span>jazzListener<span style="color:#f92672">,</span> classOf<span style="color:#f92672">[</span><span style="color:#66d9ef">Jazz</span><span style="color:#f92672">]</span><span style="color:#f92672">)</span> <span style="color:#75715e">// jazzListener 订阅 Jazz 事件
</span><span style="color:#75715e"></span>  system<span style="color:#f92672">.</span>eventStream<span style="color:#f92672">.</span>subscribe<span style="color:#f92672">(</span>musicListener<span style="color:#f92672">,</span> classOf<span style="color:#f92672">[</span><span style="color:#66d9ef">AllKindsOfMusic</span><span style="color:#f92672">]</span><span style="color:#f92672">)</span> <span style="color:#75715e">// musicListener 订阅 AllKindsOfMusic 以及它的子类 事件
</span><span style="color:#75715e"></span>
  <span style="color:#75715e">// 只有 musicListener 接收到这个事件
</span><span style="color:#75715e"></span>  system<span style="color:#f92672">.</span>eventStream<span style="color:#f92672">.</span>publish<span style="color:#f92672">(</span><span style="color:#a6e22e">Electronic</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Parov Stelar&#34;</span><span style="color:#f92672">)</span><span style="color:#f92672">)</span>

  <span style="color:#75715e">// jazzListener 和 musicListener 都会收到这个事件
</span><span style="color:#75715e"></span>  system<span style="color:#f92672">.</span>eventStream<span style="color:#f92672">.</span>publish<span style="color:#f92672">(</span><span style="color:#a6e22e">Jazz</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Sonny Rollins&#34;</span><span style="color:#f92672">)</span><span style="color:#f92672">)</span>
<span style="color:#f92672">}</span>

</code></pre></div><h2 id="subscribe-逻辑">subscribe 逻辑</h2>
<p>同步地将 subcriber 和 to 加入到 subscriptions 中，diff 应该是和之前的一次比较保证不会重复发送?</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#66d9ef">def</span> subscribe<span style="color:#f92672">(</span>subscriber<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Subscriber</span><span style="color:#f92672">,</span> to<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Classifier</span><span style="color:#f92672">)</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Boolean</span> <span style="color:#f92672">=</span> subscriptions<span style="color:#f92672">.</span>synchronized <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">val</span> diff <span style="color:#66d9ef">=</span> subscriptions<span style="color:#f92672">.</span>addValue<span style="color:#f92672">(</span>to<span style="color:#f92672">,</span> subscriber<span style="color:#f92672">)</span>
  addToCache<span style="color:#f92672">(</span>diff<span style="color:#f92672">)</span>
  diff<span style="color:#f92672">.</span>nonEmpty
<span style="color:#f92672">}</span>
</code></pre></div><p>![image-20200109114040999](/Users/xiantang/Library/Application Support/typora-user-images/image-20200109114040999.png)</p>
<p>![image-20200109131215939](/Users/xiantang/Library/Application Support/typora-user-images/image-20200109131215939.png)</p>
<p>addValue 中有个比较重要的方法，就是从 <code>subkeys</code> 也就是 subscribe 中到找对应的类。</p>
<p>可以将<code>subkeys</code> 想象为一个多叉树中的一个节点，节点的key为订阅源类型，value为所对应的订阅者 Actor</p>
<p>然后这个节点也有自己的<code>subkeys</code> 这些subkeys 为的key为上层类型的子类，同时订阅者是与是上层订阅者的拓展</p>
<p>![image-20200109140449787](/Users/xiantang/Library/Application Support/typora-user-images/image-20200109140449787.png)</p>
<p>对于重复的订阅，他会做一次去重，类似于arc diff</p>
<p>对于 <code> system.eventStream.subscribe(jazzListener, classOf[Jazz])</code></p>
<p>![image-20200109120145086](/Users/xiantang/Library/Application Support/typora-user-images/image-20200109120145086.png)</p>
<p>会产生一个这样的diff 然后加入到cache 中</p>
<p>cache 的数据结构是一个 <code>private var cache = Map.empty[Classifier, Set[Subscriber]]</code> Map 分别是订阅源和订阅者</p>
<p>对于 <code>system.eventStream.subscribe(musicListener, classOf[AllKindsOfMusic]) </code></p>
<p>![image-20200109120406852](/Users/xiantang/Library/Application Support/typora-user-images/image-20200109120406852.png)</p>
<h2 id="publish-逻辑">publish 逻辑</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#66d9ef">def</span> publish<span style="color:#f92672">(</span>event<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Event</span><span style="color:#f92672">)</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Unit</span> <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">val</span> c <span style="color:#66d9ef">=</span> classify<span style="color:#f92672">(</span>event<span style="color:#f92672">)</span>
    <span style="color:#66d9ef">val</span> recv <span style="color:#66d9ef">=</span>
      <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>cache contains c<span style="color:#f92672">)</span> cache<span style="color:#f92672">(</span>c<span style="color:#f92672">)</span> <span style="color:#75715e">// c will never be removed from cache
</span><span style="color:#75715e"></span>      <span style="color:#66d9ef">else</span>
        subscriptions<span style="color:#f92672">.</span>synchronized <span style="color:#f92672">{</span>
          <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>cache contains c<span style="color:#f92672">)</span> cache<span style="color:#f92672">(</span>c<span style="color:#f92672">)</span>
          <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
            addToCache<span style="color:#f92672">(</span>subscriptions<span style="color:#f92672">.</span>addKey<span style="color:#f92672">(</span>c<span style="color:#f92672">)</span><span style="color:#f92672">)</span>
            cache<span style="color:#f92672">(</span>c<span style="color:#f92672">)</span>
          <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
    recv<span style="color:#f92672">.</span>foreach<span style="color:#f92672">(</span>publish<span style="color:#f92672">(</span>event<span style="color:#f92672">,</span> <span style="color:#66d9ef">_</span><span style="color:#f92672">)</span><span style="color:#f92672">)</span>
  <span style="color:#f92672">}</span>
</code></pre></div><p>publish 逻辑较为简单，首先会从event中找出对应 className</p>
<p>然后走缓存逻辑，如果不在缓存中存在，就将对应的 key 更新到subkeys 多叉树中，找到对应的订阅者，并且更新到cache 中。</p>
<p>最后遍历 recv 调用publish函数 。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala">  <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">def</span> publish<span style="color:#f92672">(</span>event<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Any</span><span style="color:#f92672">,</span> subscriber<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">ActorRef</span><span style="color:#f92672">)</span> <span style="color:#66d9ef">=</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>sys <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> subscriber<span style="color:#f92672">.</span>isTerminated<span style="color:#f92672">)</span> unsubscribe<span style="color:#f92672">(</span>subscriber<span style="color:#f92672">)</span>
    <span style="color:#66d9ef">else</span> subscriber <span style="color:#f92672">!</span> event
  <span style="color:#f92672">}</span>
</code></pre></div><h1 id="actor-初始化">Actor 初始化</h1>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#66d9ef">val</span> pinger <span style="color:#66d9ef">=</span> system<span style="color:#f92672">.</span>actorOf<span style="color:#f92672">(</span><span style="color:#a6e22e">Props</span><span style="color:#f92672">[</span><span style="color:#66d9ef">Pinger</span><span style="color:#f92672">]</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;pinger&#34;</span><span style="color:#f92672">)</span>
<span style="color:#66d9ef">val</span> ponger <span style="color:#66d9ef">=</span> system<span style="color:#f92672">.</span>actorOf<span style="color:#f92672">(</span><span style="color:#a6e22e">Props</span><span style="color:#f92672">(</span>classOf<span style="color:#f92672">[</span><span style="color:#66d9ef">Ponger</span><span style="color:#f92672">]</span><span style="color:#f92672">,</span> pinger<span style="color:#f92672">)</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;ponger&#34;</span><span style="color:#f92672">)</span>
</code></pre></div><p>会调用 ActorSystem 中的actorOf方法</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#66d9ef">def</span> actorOf<span style="color:#f92672">(</span>props<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Props</span><span style="color:#f92672">)</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">ActorRef</span> <span style="color:#f92672">=</span>
<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>guardianProps<span style="color:#f92672">.</span>isEmpty<span style="color:#f92672">)</span> guardian<span style="color:#f92672">.</span>underlying<span style="color:#f92672">.</span>attachChild<span style="color:#f92672">(</span>props<span style="color:#f92672">,</span> systemService <span style="color:#66d9ef">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">)</span>
<span style="color:#66d9ef">else</span>
<span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">UnsupportedOperationException</span><span style="color:#f92672">(</span>
  <span style="color:#e6db74">&#34;cannot create top-level actor from the outside on ActorSystem with custom user guardian&#34;</span><span style="color:#f92672">)</span>
</code></pre></div><p>会从守卫Actor 下面创建一个新的Child Actor</p>
<p>会调用下边的makeChild 方法:</p>
<p>Children.scala</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#66d9ef">val</span> actor <span style="color:#66d9ef">=</span>
        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
          <span style="color:#66d9ef">val</span> childPath <span style="color:#66d9ef">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">ChildActorPath</span><span style="color:#f92672">(</span>cell<span style="color:#f92672">.</span>self<span style="color:#f92672">.</span>path<span style="color:#f92672">,</span> name<span style="color:#f92672">,</span> <span style="color:#a6e22e">ActorCell</span><span style="color:#f92672">.</span>newUid<span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">)</span>
          cell<span style="color:#f92672">.</span>provider<span style="color:#f92672">.</span>actorOf<span style="color:#f92672">(</span>
            cell<span style="color:#f92672">.</span>systemImpl<span style="color:#f92672">,</span>
            props<span style="color:#f92672">,</span>
            cell<span style="color:#f92672">.</span>self<span style="color:#f92672">,</span>
            childPath<span style="color:#f92672">,</span>
            systemService <span style="color:#66d9ef">=</span> systemService<span style="color:#f92672">,</span>
            deploy <span style="color:#66d9ef">=</span> <span style="color:#a6e22e">None</span><span style="color:#f92672">,</span>
            lookupDeploy <span style="color:#66d9ef">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">,</span>
            async <span style="color:#66d9ef">=</span> async<span style="color:#f92672">)</span>
        <span style="color:#f92672">}</span> 

initChild<span style="color:#f92672">(</span>actor<span style="color:#f92672">)</span>
actor<span style="color:#f92672">.</span>start<span style="color:#f92672">(</span><span style="color:#f92672">)</span> <span style="color:#75715e">// 绑定 actor 到 dispatcher 
</span><span style="color:#75715e"></span>actor  <span style="color:#75715e">// 返回 actor ref
</span></code></pre></div><h2 id="tell-实现">Tell 实现</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#66d9ef">final</span> <span style="color:#66d9ef">def</span> sendMessage<span style="color:#f92672">(</span>message<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Any</span><span style="color:#f92672">,</span> sender<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">ActorRef</span><span style="color:#f92672">)</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Unit</span> <span style="color:#f92672">=</span>
  sendMessage<span style="color:#f92672">(</span><span style="color:#a6e22e">Envelope</span><span style="color:#f92672">(</span>message<span style="color:#f92672">,</span> sender<span style="color:#f92672">,</span> system<span style="color:#f92672">)</span><span style="color:#f92672">)</span>
</code></pre></div><p>将message 包装为信封，调用Cell 的 sendMessage 方法</p>
<p>是因为 Cell 实现了</p>
<p>![image-20200109195143660](/Users/xiantang/Library/Application Support/typora-user-images/image-20200109195143660.png)</p>
<p>Dispatch 特质</p>
<p>其实是执行的 Dispatch 特质中的 sendMessage 方法</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#66d9ef">def</span> sendMessage<span style="color:#f92672">(</span>msg<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Envelope</span><span style="color:#f92672">)</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Unit</span> <span style="color:#f92672">=</span>
    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
      <span style="color:#66d9ef">val</span> msgToDispatch <span style="color:#66d9ef">=</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>system<span style="color:#f92672">.</span>settings<span style="color:#f92672">.</span><span style="color:#a6e22e">SerializeAllMessages</span><span style="color:#f92672">)</span> serializeAndDeserialize<span style="color:#f92672">(</span>msg<span style="color:#f92672">)</span>
        <span style="color:#66d9ef">else</span> msg

      dispatcher<span style="color:#f92672">.</span>dispatch<span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">,</span> msgToDispatch<span style="color:#f92672">)</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> handleException
</code></pre></div><p>但是我仍然有个问题，dispatcher 是我自己规定的dispather ？</p>
<p>再调用这个Actor 所对应的 dispatcher 的 dispatch 函数</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#66d9ef">protected</span><span style="color:#f92672">[</span><span style="color:#66d9ef">akka</span><span style="color:#f92672">]</span> <span style="color:#66d9ef">def</span> dispatch<span style="color:#f92672">(</span>receiver<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">ActorCell</span><span style="color:#f92672">,</span> invocation<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Envelope</span><span style="color:#f92672">)</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Unit</span> <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">val</span> mbox <span style="color:#66d9ef">=</span> receiver<span style="color:#f92672">.</span>mailbox
    mbox<span style="color:#f92672">.</span>enqueue<span style="color:#f92672">(</span>receiver<span style="color:#f92672">.</span>self<span style="color:#f92672">,</span> invocation<span style="color:#f92672">)</span>
    registerForExecution<span style="color:#f92672">(</span>mbox<span style="color:#f92672">,</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">)</span>
  <span style="color:#f92672">}</span>
</code></pre></div><p>将信封丢入对应接收者的 mailbox 中，然后将 mbox 作为参数传入 registerForExecution 注册到线程池中。</p>
<p>而这个线程池就是我预设的线程池， dispacher 只是对这个线程池做一层封装。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#66d9ef">protected</span><span style="color:#f92672">[</span><span style="color:#66d9ef">akka</span><span style="color:#f92672">]</span> <span style="color:#66d9ef">override</span> <span style="color:#66d9ef">def</span> registerForExecution<span style="color:#f92672">(</span>
      mbox<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Mailbox</span><span style="color:#f92672">,</span>
      hasMessageHint<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Boolean</span><span style="color:#f92672">,</span>
      hasSystemMessageHint<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Boolean</span><span style="color:#f92672">)</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Boolean</span> <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mbox<span style="color:#f92672">.</span>canBeScheduledForExecution<span style="color:#f92672">(</span>hasMessageHint<span style="color:#f92672">,</span> hasSystemMessageHint<span style="color:#f92672">)</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span> <span style="color:#75715e">//This needs to be here to ensure thread safety and no races
</span><span style="color:#75715e"></span>      <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mbox<span style="color:#f92672">.</span>setAsScheduled<span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
          <span style="color:#75715e">//!!!!
</span><span style="color:#75715e"></span>          executorService<span style="color:#f92672">.</span>execute<span style="color:#f92672">(</span>mbox<span style="color:#f92672">)</span>
          <span style="color:#66d9ef">true</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">{</span>
       		<span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>
        <span style="color:#f92672">}</span>
      <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">false</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">false</span>
  <span style="color:#f92672">}</span>
</code></pre></div><p>使用内部的线程池来执行这个 MailBox 对象</p>
<p>既然 MailBox 可以被执行 它一定实现了 Runnable 方法 来看看他的实现:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#66d9ef">override</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">def</span> run<span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Unit</span> <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
      <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#f92672">!</span>isClosed<span style="color:#f92672">)</span> <span style="color:#f92672">{</span> <span style="color:#75715e">//Volatile read, needed here
</span><span style="color:#75715e"></span>        processAllSystemMessages<span style="color:#f92672">(</span><span style="color:#f92672">)</span> <span style="color:#75715e">//First, deal with any system messages
</span><span style="color:#75715e"></span>        processMailbox<span style="color:#f92672">(</span><span style="color:#f92672">)</span> <span style="color:#75715e">//Then deal with messages
</span><span style="color:#75715e"></span>      <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">finally</span> <span style="color:#f92672">{</span>
      setAsIdle<span style="color:#f92672">(</span><span style="color:#f92672">)</span> <span style="color:#75715e">//Volatile write, needed here
</span><span style="color:#75715e"></span>      dispatcher<span style="color:#f92672">.</span>registerForExecution<span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">)</span>
    <span style="color:#f92672">}</span>
  <span style="color:#f92672">}</span>
</code></pre></div><p>来主要看一下 processMailbox 方法的实现吧</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#a6e22e">@tailrec</span> <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">def</span> processMailbox<span style="color:#f92672">(</span>
      left<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Int</span> <span style="color:#f92672">=</span> java<span style="color:#f92672">.</span>lang<span style="color:#f92672">.</span><span style="color:#a6e22e">Math</span><span style="color:#f92672">.</span>max<span style="color:#f92672">(</span>dispatcher<span style="color:#f92672">.</span>throughput<span style="color:#f92672">,</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">)</span><span style="color:#f92672">,</span>
      deadlineNs<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Long</span> <span style="color:#f92672">=</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>dispatcher<span style="color:#f92672">.</span>isThroughputDeadlineTimeDefined<span style="color:#f92672">)</span>
          <span style="color:#a6e22e">System</span><span style="color:#f92672">.</span>nanoTime <span style="color:#f92672">+</span> dispatcher<span style="color:#f92672">.</span>throughputDeadlineTime<span style="color:#f92672">.</span>toNanos
        <span style="color:#66d9ef">else</span> <span style="color:#ae81ff">0L</span><span style="color:#f92672">)</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Unit</span> <span style="color:#f92672">=</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>shouldProcessMessage<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
      <span style="color:#66d9ef">val</span> next <span style="color:#66d9ef">=</span> dequeue<span style="color:#f92672">(</span><span style="color:#f92672">)</span>
      <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>next ne <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#a6e22e">Mailbox</span><span style="color:#f92672">.</span>debug<span style="color:#f92672">)</span> println<span style="color:#f92672">(</span>actor<span style="color:#f92672">.</span>self <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; processing message &#34;</span> <span style="color:#f92672">+</span> next<span style="color:#f92672">)</span>
        actor<span style="color:#f92672">.</span>invoke<span style="color:#f92672">(</span>next<span style="color:#f92672">)</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#a6e22e">Thread</span><span style="color:#f92672">.</span>interrupted<span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">)</span>
          <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">InterruptedException</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Interrupted while processing actor messages&#34;</span><span style="color:#f92672">)</span>
        processAllSystemMessages<span style="color:#f92672">(</span><span style="color:#f92672">)</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#f92672">(</span>left <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">)</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">(</span><span style="color:#f92672">!</span>dispatcher<span style="color:#f92672">.</span>isThroughputDeadlineTimeDefined <span style="color:#f92672">||</span> <span style="color:#f92672">(</span><span style="color:#a6e22e">System</span><span style="color:#f92672">.</span>nanoTime <span style="color:#f92672">-</span> deadlineNs<span style="color:#f92672">)</span> <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">)</span><span style="color:#f92672">)</span>
          processMailbox<span style="color:#f92672">(</span>left <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">,</span> deadlineNs<span style="color:#f92672">)</span>
      <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
</code></pre></div><p>很简单的实现，使用了尾递归的方式，</p>
<ol>
<li>首先计算出 left 也就是分发器的吞吐量</li>
<li>然后从队列里面出队一个元素</li>
<li>调用actor 的invoke 方法</li>
<li>继续向下调用直到 left &lt;1  或者</li>
</ol>
<p>有两个关键的参数，</p>
<p>throughput 也就是单次执行  <code>executorService.execute(mbox)</code> 所消费消息的数量。超出这个数量的消息将会交给下次执行这个 mbox 的时候执行。</p>
<p><code>deadlineNs</code>  发送throughput数量消息的截止时间，保证throughput的消息要在截止时间内完成。</p>
<p>调用 actor 的 invoke 方法下面会调用 ActorCell 的 receiveMessage 方法</p>
<p><code>actor.aroundReceive(behaviorStack.head, msg)</code></p>
<p>获得栈顶的 Receive 偏函数，调用 aroundReceive 来执行操作</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#66d9ef">protected</span><span style="color:#f92672">[</span><span style="color:#66d9ef">akka</span><span style="color:#f92672">]</span> <span style="color:#66d9ef">def</span> aroundReceive<span style="color:#f92672">(</span>receive<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Actor</span><span style="color:#66d9ef">.</span><span style="color:#66d9ef">Receive</span><span style="color:#f92672">,</span> msg<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Any</span><span style="color:#f92672">)</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Unit</span> <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>
  <span style="color:#75715e">// optimization: avoid allocation of lambda
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>receive<span style="color:#f92672">.</span>applyOrElse<span style="color:#f92672">(</span>msg<span style="color:#f92672">,</span> <span style="color:#a6e22e">Actor</span><span style="color:#f92672">.</span>notHandledFun<span style="color:#f92672">)</span><span style="color:#f92672">.</span>asInstanceOf<span style="color:#f92672">[</span><span style="color:#66d9ef">AnyRef</span><span style="color:#f92672">]</span> eq <span style="color:#a6e22e">Actor</span><span style="color:#f92672">.</span><span style="color:#a6e22e">NotHandled</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    unhandled<span style="color:#f92672">(</span>msg<span style="color:#f92672">)</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>如果receive 没有match对应的message，使用了偏函数的 applyOrElse 捕获剩下的值域，判断返回值是否和 NotHandled 相等。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#66d9ef">def</span> unhandled<span style="color:#f92672">(</span>message<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Any</span><span style="color:#f92672">)</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Unit</span> <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>
  message <span style="color:#66d9ef">match</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">Terminated</span><span style="color:#f92672">(</span>dead<span style="color:#f92672">)</span> <span style="color:#66d9ef">=&gt;</span> <span style="color:#66d9ef">throw</span> <span style="color:#a6e22e">DeathPactException</span><span style="color:#f92672">(</span>dead<span style="color:#f92672">)</span>
    <span style="color:#66d9ef">case</span> <span style="color:#66d9ef">_</span>                <span style="color:#66d9ef">=&gt;</span> context<span style="color:#f92672">.</span>system<span style="color:#f92672">.</span>eventStream<span style="color:#f92672">.</span>publish<span style="color:#f92672">(</span><span style="color:#a6e22e">UnhandledMessage</span><span style="color:#f92672">(</span>message<span style="color:#f92672">,</span> sender<span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">,</span> self<span style="color:#f92672">)</span><span style="color:#f92672">)</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>对message 做一次模式匹配，如果是没有handle的message 就将它作为订阅发出。</p>
<p>这里我们可以使用一个订阅者 <code>system.eventStream.subscribe(listener, classOf[UnhandledMessage]) </code> 来订阅这些消息，进行日志输出。</p>
<ul class="pa0">
  
</ul>
<div class="mt6">
      
      
      </div>
    </section>

    <aside class="w-30-l mt6-l">




</aside>

  </article>

    </main>
    <footer class="bg-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://xiantang.github.io/" >
    &copy;  xiantang 2020 
  </a>
    <div>












</div>
  </div>
</footer>

    

  <script src="/dist/js/app.3fc0f988d21662902933.js"></script>


  </body>
</html>
