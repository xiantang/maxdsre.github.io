<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>xiantang </title>
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="generator" content="Hugo 0.63.0-DEV" />
    
    
      <META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">
    

    
    
      <link href="/dist/css/app.3f5912c237ddd38c8e76debe081c7ca7.css" rel="stylesheet">
    

    

    
      
    

    
    
    <meta property="og:title" content="" />
<meta property="og:description" content="负载均衡算法维持会话使用的算法 7层 nio 中 在 unix 函数用了什么？ epoll ？ cas 自旋的好处？ 线程池如何运作？他的参数是什么？阻塞队列的作用是什么？为什么要有阻塞队列 nio 多路复用是同步还是异步的? mysql 悲观锁乐观锁 用sql 怎么写 线程池在请求来了的时候是怎么创建线程和利用请求队列的？ mysql 事务是怎么实现的? HashMap 线程不安全的情况? 1.8 1.7 分析 聚集索引与非聚集索引的区别 mysql 默认的隔离级别 volatile 的实现 内存屏障的实现 指令重排序的应用场景 mysql 的两个引擎的区别 性能 差多少 为什么？ chm 怎么计算分段的数量 构造函数里面有 忘了 项目中有没有用到过行锁，怎么实现的（四种锁）？ 死锁发生的条件，对锁超时，如果遇到抢占锁怎么办？  LVS 持久性连接 从用户端来解释，就是当一个用户第一次访问被负载均衡代理到后端服务器A并登录后，服务器A上保留了用户的登录信息；当用户再次发送请求时，根据负载均衡策略可能被代理到后端不同的服务器，例如服务器B，由于这台服务器B没有用户的登录信息，所以导致用户需要重新登录。这对用户来说是不可忍受的。所以，在实施负载均衡的时候，我们必须考虑Session的问题。
问题出在哪里？ 如何处理？  会话保持（案例：Nginx、Haproxy） 会话复制（案例：Tomcat） 会话共享（案例：Memcached、Redis）  我们这里主要讲的是 会话保持的方式，这个方式也主要是从负载均衡这一层进行解决。
首先讲两个十分通用的方式吧！
会话保持 IP_HASH 每个请求按照访问的ip的Hash结果进行分配，这样每个访客可以访问同一个后端服务器，达到保持Session的方法。
upstream bakend { ip_hash; server192.168.0.11:80; server192.168.0.12:80; } Cookie 识别 也就是Haproxy在用户第一次访问的后在用户浏览器插入了一个Cookie，用户下一次访问的时候浏览器就会带上这个Cookie给Haproxy，Haproxy进行识别" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://xiantang.github.io/java/%E9%9D%A2%E7%BB%8F/%E6%9C%89%E8%B5%9E%E4%B8%80%E9%9D%A2/" />

<meta itemprop="name" content="">
<meta itemprop="description" content="负载均衡算法维持会话使用的算法 7层 nio 中 在 unix 函数用了什么？ epoll ？ cas 自旋的好处？ 线程池如何运作？他的参数是什么？阻塞队列的作用是什么？为什么要有阻塞队列 nio 多路复用是同步还是异步的? mysql 悲观锁乐观锁 用sql 怎么写 线程池在请求来了的时候是怎么创建线程和利用请求队列的？ mysql 事务是怎么实现的? HashMap 线程不安全的情况? 1.8 1.7 分析 聚集索引与非聚集索引的区别 mysql 默认的隔离级别 volatile 的实现 内存屏障的实现 指令重排序的应用场景 mysql 的两个引擎的区别 性能 差多少 为什么？ chm 怎么计算分段的数量 构造函数里面有 忘了 项目中有没有用到过行锁，怎么实现的（四种锁）？ 死锁发生的条件，对锁超时，如果遇到抢占锁怎么办？  LVS 持久性连接 从用户端来解释，就是当一个用户第一次访问被负载均衡代理到后端服务器A并登录后，服务器A上保留了用户的登录信息；当用户再次发送请求时，根据负载均衡策略可能被代理到后端不同的服务器，例如服务器B，由于这台服务器B没有用户的登录信息，所以导致用户需要重新登录。这对用户来说是不可忍受的。所以，在实施负载均衡的时候，我们必须考虑Session的问题。
问题出在哪里？ 如何处理？  会话保持（案例：Nginx、Haproxy） 会话复制（案例：Tomcat） 会话共享（案例：Memcached、Redis）  我们这里主要讲的是 会话保持的方式，这个方式也主要是从负载均衡这一层进行解决。
首先讲两个十分通用的方式吧！
会话保持 IP_HASH 每个请求按照访问的ip的Hash结果进行分配，这样每个访客可以访问同一个后端服务器，达到保持Session的方法。
upstream bakend { ip_hash; server192.168.0.11:80; server192.168.0.12:80; } Cookie 识别 也就是Haproxy在用户第一次访问的后在用户浏览器插入了一个Cookie，用户下一次访问的时候浏览器就会带上这个Cookie给Haproxy，Haproxy进行识别">

<meta itemprop="wordCount" content="855">



<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content=""/>
<meta name="twitter:description" content="负载均衡算法维持会话使用的算法 7层 nio 中 在 unix 函数用了什么？ epoll ？ cas 自旋的好处？ 线程池如何运作？他的参数是什么？阻塞队列的作用是什么？为什么要有阻塞队列 nio 多路复用是同步还是异步的? mysql 悲观锁乐观锁 用sql 怎么写 线程池在请求来了的时候是怎么创建线程和利用请求队列的？ mysql 事务是怎么实现的? HashMap 线程不安全的情况? 1.8 1.7 分析 聚集索引与非聚集索引的区别 mysql 默认的隔离级别 volatile 的实现 内存屏障的实现 指令重排序的应用场景 mysql 的两个引擎的区别 性能 差多少 为什么？ chm 怎么计算分段的数量 构造函数里面有 忘了 项目中有没有用到过行锁，怎么实现的（四种锁）？ 死锁发生的条件，对锁超时，如果遇到抢占锁怎么办？  LVS 持久性连接 从用户端来解释，就是当一个用户第一次访问被负载均衡代理到后端服务器A并登录后，服务器A上保留了用户的登录信息；当用户再次发送请求时，根据负载均衡策略可能被代理到后端不同的服务器，例如服务器B，由于这台服务器B没有用户的登录信息，所以导致用户需要重新登录。这对用户来说是不可忍受的。所以，在实施负载均衡的时候，我们必须考虑Session的问题。
问题出在哪里？ 如何处理？  会话保持（案例：Nginx、Haproxy） 会话复制（案例：Tomcat） 会话共享（案例：Memcached、Redis）  我们这里主要讲的是 会话保持的方式，这个方式也主要是从负载均衡这一层进行解决。
首先讲两个十分通用的方式吧！
会话保持 IP_HASH 每个请求按照访问的ip的Hash结果进行分配，这样每个访客可以访问同一个后端服务器，达到保持Session的方法。
upstream bakend { ip_hash; server192.168.0.11:80; server192.168.0.12:80; } Cookie 识别 也就是Haproxy在用户第一次访问的后在用户浏览器插入了一个Cookie，用户下一次访问的时候浏览器就会带上这个Cookie给Haproxy，Haproxy进行识别"/>

  </head>

  <body class="ma0 avenir bg-near-white">

    
   
  

  <header>
    <div class="bg-black">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="https://xiantang.github.io/" class="f3 fw2 hover-white no-underline white-90 dib">
      xiantang
    </a>
    <div class="flex-l items-center">
      

      
      













    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  
  <article class="flex-l flex-wrap justify-between mw8 center ph3">

    <header class="mt4 w-100">
      <p class="f6 b helvetica tracked">
          
        JAVAS
      </p>
      <h1 class="f1 athelas mb1"></h1>
      
      
      <time class="f6 mv4 dib tracked" datetime="0001-01-01T00:00:00Z">January 1, 0001</time>
      
      
    </header>

    <section class="nested-copy-line-height lh-copy serif f4 nested-links nested-img mid-gray pr4-l w-two-thirds-l"><ul>
<li><del>负载均衡算法维持会话使用的算法 7层</del></li>
<li><del>nio 中 在 unix 函数用了什么？ epoll ？</del></li>
<li><del>cas 自旋的好处？</del></li>
<li><del>线程池如何运作？他的参数是什么？阻塞队列的作用是什么？为什么要有阻塞队列</del></li>
<li><del>nio 多路复用是同步还是异步的?</del></li>
<li><del>mysql 悲观锁乐观锁 用sql 怎么写</del></li>
<li><del>线程池在请求来了的时候是怎么创建线程和利用请求队列的？</del></li>
<li><del>mysql 事务是怎么实现的?</del></li>
<li><del>HashMap 线程不安全的情况? 1.8 1.7 分析</del></li>
<li><del>聚集索引与非聚集索引的区别</del></li>
<li><del>mysql 默认的隔离级别</del></li>
<li><del>volatile 的实现 内存屏障的实现 指令重排序的应用场景</del></li>
<li><del>mysql 的两个引擎的区别  性能 差多少  为什么？</del></li>
<li>chm 怎么计算分段的数量 构造函数里面有 忘了</li>
<li>项目中有没有用到过行锁，怎么实现的（四种锁）？</li>
<li><del>死锁发生的条件，对锁超时，如果遇到抢占锁怎么办？</del></li>
</ul>
<h2 id="lvs-持久性连接">LVS 持久性连接</h2>
<p>从用户端来解释，就是当一个用户第一次访问被负载均衡代理到后端服务器A并登录后，服务器A上保留了用户的登录信息；当用户再次发送请求时，根据负载均衡策略可能被代理到后端不同的服务器，例如服务器B，由于这台服务器B没有用户的登录信息，所以导致用户需要重新登录。这对用户来说是不可忍受的。所以，在实施负载均衡的时候，我们必须考虑Session的问题。</p>
<h3 id="问题出在哪里-如何处理">问题出在哪里？ 如何处理？</h3>
<ul>
<li>会话保持（案例：Nginx、Haproxy）</li>
<li>会话复制（案例：Tomcat）</li>
<li>会话共享（案例：Memcached、Redis）</li>
</ul>
<p>我们这里主要讲的是 会话保持的方式，这个方式也主要是从负载均衡这一层进行解决。</p>
<p>首先讲两个十分通用的方式吧！</p>
<h3 id="会话保持">会话保持</h3>
<h4 id="ip_hash">IP_HASH</h4>
<p>每个请求按照访问的ip的Hash结果进行分配，这样每个访客可以访问同一个后端服务器，达到保持Session的方法。</p>
<pre><code>upstream bakend {
   ip_hash;
   server192.168.0.11:80;
   server192.168.0.12:80;
 }
</code></pre><h4 id="cookie-识别">Cookie 识别</h4>
<p>也就是Haproxy在用户第一次访问的后在用户浏览器插入了一个Cookie，用户下一次访问的时候浏览器就会带上这个Cookie给Haproxy，Haproxy进行识别</p>
<p><code>配置指令:cookie  SESSION_COOKIE  insert indirect nocache</code></p>
<p>配置例子如下：</p>
<pre><code>cookie SERVERID insert indirect nocache
server web01 192.168.56.11:8080 check cookie web01
server web02 192.168.56.12:8080 check cookie web02
</code></pre><p>其次就是一个三方模块 nginx-sticky-module</p>
<p>注意：cookie需要浏览器支持，且有时候会泄露数据</p>
<h4 id="nginx-sticky-module">nginx-sticky-module</h4>
<p>工作原理:</p>
<ul>
<li>Sticky是nginx的一个模块，它是基于cookie的一种nginx的负载均衡解决方案，通过分发和识别cookie，来使同一个客户端的请求落在同一台服务器上，默认标识名为route</li>
</ul>
<ol>
<li>客户端首次发起访问请求，nginx接收后，发现请求头没有cookie，则以轮询方式将请求分发给后端服务器。</li>
<li>后端服务器处理完请求，将响应数据返回给nginx。</li>
<li>此时nginx生成带route的cookie，返回给客户端。route的值与后端服务器对应，可能是明文，也可能是md5、sha1等Hash值</li>
<li>客户端接收请求，并保存带route的cookie。</li>
<li>当客户端下一次发送请求时，会带上route，nginx根据接收到的cookie中的route值，转发给对应的后端服务器。</li>
</ol>
<p><img src="../../../images/1562398604770.png" alt="1562398604770"></p>
<p>无论如何刷新你都会发现这个 route 不会改变。</p>
<h3 id="会话共享">会话共享</h3>
<p>既然会话保持和会话复制都不完美，那么我们为什么不把Session放在一个统一的地方呢，这样集群中的所有节点都在一个地方进行Session的存取就可以解决问题。</p>
<p>​    <strong>Session存放到哪里？</strong></p>
<p>对于Session来说，肯定是频繁使用的，虽然你可以把它存放在数据库中，但是真正生产环境中我更推荐存放在性能更快的分布式KV数据中，例如：Memcached和Redis。</p>
<h2 id="nio-中-在-unix-函数用了什么-epoll-">nio 中 在 unix 函数用了什么？ epoll ？</h2>
<p>select，poll，epoll都是IO多路复用的机制。</p>
<p>I/O多路复用就是通过一种机制，一个进程可以监视多个描述符，一旦某个描述符就绪（一般是读就绪或者写就绪），能够通知程序进行相应的读写操作。</p>
<p>但select，poll，epoll本质上都是同步I/O，因为他们都需要在读写事件就绪后自己负责进行读写，也就是说这个读写过程是阻塞的，而异步I/O则无需自己负责进行读写，异步I/O的实现会负责把数据从内核拷贝到用户空间。</p>
<h3 id="select">select()</h3>
<p><code>int select (int n, fd_set *readfds, fd_set *writefds, fd_set *exceptfds, struct timeval *timeout);</code></p>
<p>select 描述符分为3类 writefds、readfds、和exceptfds</p>
<p>函数返回。当select函数返回后，可以 通过遍历fdset，来找到就绪的描述符。</p>
<p>优点：select目前几乎在所有的平台上支持，其良好跨平台支持也是它的一个优点。</p>
<p>缺点 ： select的一 个缺点在于单个进程能够监视的文件描述符的数量存在最大限制，在Linux上一般为1024。</p>
<h3 id="对于nio">对于NIO</h3>
<p>执行selector.select()方法，poll0 函数把指向socket 句柄和事件的内存地址传给底层函数。</p>
<ol>
<li>如果之前没有发生事件，程序就阻塞在select处，当然不会一直阻塞，因为epoll在timeout时间内如果没有事件，也会返回。</li>
<li>一旦有对应的事件发生，poll0方法就会返回。</li>
<li>统计有事件发生的SelectionKey数量，并把符合条件发生事件的SelectionKey添加到selectedKeys哈希表中，提供给后续使用。</li>
</ol>
<ul>
<li>在早期的JDK1.4和1.5 update10版本之前，Selector基于select/poll模型实现</li>
<li>在JDK1.5 update10和linux core2.6以上版本，sun优化了Selctor的实现，底层使用epoll替换了select/poll。</li>
</ul>
<h3 id="线程如何运作呢">线程如何运作呢？</h3>
<p><img src="../../../images/b17448d868e81c5a53c419a70d3fe59e" alt="img"></p>
<h3 id="乐观锁">乐观锁</h3>
<p><a href="https://juejin.im/post/5c9b1b7df265da60e21c0b57#heading-8">https://juejin.im/post/5c9b1b7df265da60e21c0b57#heading-8</a></p>
<p>乐观锁 MVCC 多版本控制</p>
<h3 id="隔离级别">隔离级别</h3>
<p><code>MySQL</code>是一个服务器／客户端架构的软件，对于同一个服务器来说，可以有若干个客户端与之连接，每个客户端与服务器连接上之后，就可以称之为一个会话（<code>Session</code>）。我们可以同时在不同的会话里输入各种语句，这些语句可以作为事务的一部分进行处理。不同的会话可以同时发送请求，也就是说服务器可能同时在处理多个事务，这样子就会导致不同的事务可能同时访问到相同的记录。我们前边说过事务有一个特性称之为<code>隔离性</code>，理论上在某个事务对某个数据进行访问时，其他事务应该进行排队，当该事务提交之后，其他事务才可以继续访问这个数据。但是这样子的话对性能影响太大，所以设计数据库的大叔提出了各种<code>隔离级别</code>，来最大限度的提升系统并发处理事务的能力，但是这也是以牺牲一定的<code>隔离性</code>来达到的。</p>
<h3 id="未提交读">未提交读:</h3>
<p>一个事务读到了另一个未提交事务修改过的数据</p>
<p><img src="../../../images/169bde35552fb49c" alt="image_1d6t5hhamcd61qkjk9v1ag8171o7u.png-95.6kB"></p>
<p>如果session B 进行回滚，那么session A 就会读到一个存在的数据。</p>
<p>就是<code>脏读</code>。</p>
<h3 id="已提交读">已提交读</h3>
<p>一个事务只能读到另一个已经提交的事务修改过的数据，并且其他事务每对该数据进行一次修改并提交后，该事务都能查询得到最新值。</p>
<p><img src="../../../images/169bde3557ef6578" alt="image_1d6t64lgg1j4mtp818f61n09t6l8o.png-133.1kB"></p>
<p>对于某个处在在<code>已提交读</code>隔离级别下的事务来说，只要其他事务修改了某个数据的值，并且之后提交了，那么该事务就会读到该数据的最新值，比方说：</p>
<p><img src="../../../images/169bde356084eb69" alt="image_1d6urs4l0g799959e1jsj1cvqai.png-170.6kB"></p>
<p>我们在<code>Session B</code>中提交了几个隐式事务，这些事务都修改了<code>id</code>为<code>1</code>的记录的列c的值，每次事务提交之后，<code>Session A</code>中的事务都可以查看到最新的值。这种现象也被称之为<code>不可重复读</code>。</p>
<h3 id="可重复读">可重复读</h3>
<p>在一些业务场景中，一个事务只能读到另一个已经提交的事务修改过的数据，但是第一次读过某条记录后，即使其他事务修改了该记录的值并且提交，该事务之后再读该条记录时，读到的仍是第一次读到的值，而不是每次都读到不同的数据。那么这种<code>隔离级别</code>就称之为<code>可重复读</code>（英文名：<code>REPEATABLE READ</code>），如图所示：</p>
<p><img src="../../../images/169bde35523d0ae5" alt="image_1d6useq9aagi9981sm21b011dt4bf.png-171.1kB">
从图中可以看出来，<code>Session A</code>中的事务在第一次读取<code>id</code>为<code>1</code>的记录时，列<code>c</code>的值为<code>'刘备'</code>，之后虽然<code>Session B</code>中隐式提交了多个事务，每个事务都修改了这条记录，但是<code>Session A</code>中的事务读到的列<code>c</code>的值仍为<code>'刘备'</code>，与第一次读取的值是相同的。</p>
<h3 id="串行化">串行化</h3>
<p><img src="../../../images/169bde3556310c02" alt="image_1d6uu0sk41213olj102t1tsa10o9ds.png-122.9kB"></p>
<p>如图所示，当<code>Session B</code>中的事务更新了<code>id</code>为<code>1</code>的记录后，之后<code>Session A</code>中的事务再去访问这条记录时就被卡住了，直到<code>Session B</code>中的事务提交之后，<code>Session A</code>中的事务才可以获取到查询结果。</p>
<h3 id="事务的实现">事务的实现</h3>
<h3 id="版本链">版本链</h3>
<p>对于使用<code>InnoDB</code>存储引擎的表来说，它的聚簇索引记录中都包含两个必要的隐藏列（<code>row_id</code>并不是必要的，我们创建的表中有主键或者非NULL唯一键时都不会包含<code>row_id</code>列）：</p>
<ul>
<li>trx_id: 每次对某条聚簇索引记录改变时候，都会把对应事务赋值给trx_id隐藏列。</li>
<li>roll_pointer:每次对某条聚簇索引记录进行改动时，都会把旧的版本写入到<code>undo日志</code>中。</li>
</ul>
<p><img src="../../../images/169bf19851d3dce6-1562739070773" alt="image_1d6vemvvn1db6h431ekvsp158m19.png-15kB"></p>
<p>每次对记录进行改动，都会记录一条<code>undo日志</code>，每条<code>undo日志</code>也都有一个<code>roll_pointer</code>属性（<code>INSERT</code>操作对应的<code>undo日志</code>没有该属性，因为该记录并没有更早的版本），可以将这些<code>undo日志</code>都连起来，串成一个链表，所以现在的情况就像下图一样：</p>
<p><img src="../../../images/169bf198524e1b34" alt="image_1d6vfrv111j4guetptcts1qgp40.png-57.1kB"></p>
<ul>
<li>对于未提交读只要获取最新一条就行了</li>
</ul>
<p>对于提交读和重复读采用ReadView:</p>
<p>把当前活跃的id放到一个列表中命名为 m_ids</p>
<ul>
<li>
<p>如果被访问版本的<code>trx_id</code>属性值小于<code>m_ids</code>列表中最小的事务id，表明生成该版本的事务在生成<code>ReadView</code>前已经提交，所以该版本可以被当前事务访问。</p>
</li>
<li>
<p>如果被访问版本的<code>trx_id</code>属性值大于<code>m_ids</code>列表中最大的事务id，表明生成该版本的事务在生成<code>ReadView</code>后才生成，所以该版本不可以被当前事务访问。</p>
</li>
<li>
<p>如果被访问版本的<code>trx_id</code>属性值在<code>m_ids</code>列表中最大的事务id和最小事务id之间，那就需要判断一下<code>trx_id</code>属性值是不是在<code>m_ids</code>列表中，如果在，说明创建<code>ReadView</code>时生成该版本的事务还是活跃的，该版本不可以被访问；如果不在，说明创建<code>ReadView</code>时生成该版本的事务已经被提交，该版本可以被访问。</p>
</li>
</ul>
<p>提交读是在每次selelct的时候生成一个ReadView</p>
<p>可重复读是在第一次select的时候生成一个ReadView，之后复用</p>
<h2 id="hashmap-线程不安全的情况-18-17-分析">HashMap 线程不安全的情况? 1.8 1.7 分析</h2>
<ul>
<li>1.7 成环 数据丢失 数据覆盖</li>
<li>1.8 数据覆盖</li>
</ul>
<h4 id="17-成环">1.7 成环</h4>
<p>假设现在有两个线程A、B同时对下面这个<code>HashMap</code>进行扩容操作：
<img src="../../../images/20190507171801023_GIMCAP.jpg" alt="img">
正常扩容后的结果是下面这样的：
<img src="../../../images/20190507171801166_XSAERU.jpg" alt="img">
但是当线程A执行到上面<code>transfer</code>函数的第11行代码时，CPU时间片耗尽，线程A被挂起。即如下图中位置所示：</p>
<p><img src="../../../images/20190507171801286_FKKWCB.jpg" alt="img"></p>
<p>此时线程A中：e=3、next=7、e.next=null
<img src="../../../images/20190507171801394_DJPDIH.jpg" alt="img">
当线程A的时间片耗尽后，CPU开始执行线程B，并在线程B中成功的完成了数据迁移
<img src="../../../images/20190507171801597_FYMMZS.jpg" alt="img">
重点来了，根据Java内存模式可知，线程B执行完数据迁移后，此时主内存中<code>newTable</code>和<code>table</code>都是最新的，也就是说：7.next=3、3.next=null。</p>
<p>随后线程A获得CPU时间片继续执行<code>newTable[i] = e</code>，将3放入新数组对应的位置，执行完此轮循环后线程A的情况如下：
<img src="../../../images/20190507171801695_INENKV.jpg" alt="img">
接着继续执行下一轮循环，此时e=7，从主内存中读取e.next时发现主内存中7.next=3，于是乎next=3，并将7采用头插法的方式放入新数组中，并继续执行完此轮循环，结果如下：
<img src="../../../images/20190507171801780_BKSEQA.jpg" alt="img">
执行下一次循环可以发现，next=e.next=null，所以此轮循环将会是最后一轮循环。接下来当执行完e.next=newTable[i]即3.next=7后，3和7之间就相互连接了，当执行完newTable[i]=e后，3被头插法重新插入到链表中，执行结果如下图所示：
<img src="../../../images/20190507171801907_JCCWBG.jpg" alt="img">
上面说了此时e.next=null即next=null，当执行完e=null后，将不会进行下一轮循环。到此线程A、B的扩容操作完成，很明显当线程A执行完后，<code>HashMap</code>中出现了环形结构，当在以后对该<code>HashMap</code>进行操作时会出现死循环。</p>
<p>并且从上图可以发现，元素5在扩容期间被莫名的丢失了，这就发生了数据丢失的问题。</p>
<h4 id="18-数据覆盖">1.8 数据覆盖</h4>
<p>根据上面JDK1.7出现的问题，在JDK1.8中已经得到了很好的解决，如果你去阅读1.8的源码会发现找不到<code>transfer</code>函数，因为JDK1.8直接在<code>resize</code>函数中完成了数据迁移。另外说一句，JDK1.8在进行元素插入时使用的是尾插法。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">final</span> V <span style="color:#a6e22e">putVal</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> hash<span style="color:#f92672">,</span> K key<span style="color:#f92672">,</span> V value<span style="color:#f92672">,</span> <span style="color:#66d9ef">boolean</span> onlyIfAbsent<span style="color:#f92672">,</span>
                   <span style="color:#66d9ef">boolean</span> evict<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        Node<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span>V<span style="color:#f92672">&gt;</span><span style="color:#f92672">[</span><span style="color:#f92672">]</span> tab<span style="color:#f92672">;</span> Node<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span>V<span style="color:#f92672">&gt;</span> p<span style="color:#f92672">;</span> <span style="color:#66d9ef">int</span> n<span style="color:#f92672">,</span> i<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#f92672">(</span>tab <span style="color:#f92672">=</span> table<span style="color:#f92672">)</span> <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">|</span><span style="color:#f92672">|</span> <span style="color:#f92672">(</span>n <span style="color:#f92672">=</span> tab<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">)</span> <span style="color:#f92672">=</span><span style="color:#f92672">=</span> 0<span style="color:#f92672">)</span>
            n <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>tab <span style="color:#f92672">=</span> resize<span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">)</span><span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#f92672">(</span>p <span style="color:#f92672">=</span> tab<span style="color:#f92672">[</span>i <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>n <span style="color:#f92672">-</span> 1<span style="color:#f92672">)</span> <span style="color:#f92672">&amp;</span> hash<span style="color:#f92672">]</span><span style="color:#f92672">)</span> <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span>
            tab<span style="color:#f92672">[</span>i<span style="color:#f92672">]</span> <span style="color:#f92672">=</span> newNode<span style="color:#f92672">(</span>hash<span style="color:#f92672">,</span> key<span style="color:#f92672">,</span> value<span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
            Node<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span>V<span style="color:#f92672">&gt;</span> e<span style="color:#f92672">;</span> K k<span style="color:#f92672">;</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>p<span style="color:#f92672">.</span><span style="color:#a6e22e">hash</span> <span style="color:#f92672">=</span><span style="color:#f92672">=</span> hash <span style="color:#f92672">&amp;</span><span style="color:#f92672">&amp;</span>
                <span style="color:#f92672">(</span><span style="color:#f92672">(</span>k <span style="color:#f92672">=</span> p<span style="color:#f92672">.</span><span style="color:#a6e22e">key</span><span style="color:#f92672">)</span> <span style="color:#f92672">=</span><span style="color:#f92672">=</span> key <span style="color:#f92672">|</span><span style="color:#f92672">|</span> <span style="color:#f92672">(</span>key <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;</span><span style="color:#f92672">&amp;</span> key<span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>k<span style="color:#f92672">)</span><span style="color:#f92672">)</span><span style="color:#f92672">)</span><span style="color:#f92672">)</span>
                e <span style="color:#f92672">=</span> p<span style="color:#f92672">;</span>
            <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>p <span style="color:#66d9ef">instanceof</span> TreeNode<span style="color:#f92672">)</span>
                e <span style="color:#f92672">=</span> <span style="color:#f92672">(</span><span style="color:#f92672">(</span>TreeNode<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span>V<span style="color:#f92672">&gt;</span><span style="color:#f92672">)</span>p<span style="color:#f92672">)</span><span style="color:#f92672">.</span><span style="color:#a6e22e">putTreeVal</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">,</span> tab<span style="color:#f92672">,</span> hash<span style="color:#f92672">,</span> key<span style="color:#f92672">,</span> value<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
            <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> binCount <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span> <span style="color:#f92672">;</span> <span style="color:#f92672">+</span><span style="color:#f92672">+</span>binCount<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#f92672">(</span>e <span style="color:#f92672">=</span> p<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">)</span> <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                        p<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span> <span style="color:#f92672">=</span> newNode<span style="color:#f92672">(</span>hash<span style="color:#f92672">,</span> key<span style="color:#f92672">,</span> value<span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
                        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>binCount <span style="color:#f92672">&gt;</span><span style="color:#f92672">=</span> TREEIFY_THRESHOLD <span style="color:#f92672">-</span> 1<span style="color:#f92672">)</span> <span style="color:#75715e">// -1 for 1st
</span><span style="color:#75715e"></span>                            treeifyBin<span style="color:#f92672">(</span>tab<span style="color:#f92672">,</span> hash<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
                        <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
                    <span style="color:#f92672">}</span>
                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>e<span style="color:#f92672">.</span><span style="color:#a6e22e">hash</span> <span style="color:#f92672">=</span><span style="color:#f92672">=</span> hash <span style="color:#f92672">&amp;</span><span style="color:#f92672">&amp;</span>
                        <span style="color:#f92672">(</span><span style="color:#f92672">(</span>k <span style="color:#f92672">=</span> e<span style="color:#f92672">.</span><span style="color:#a6e22e">key</span><span style="color:#f92672">)</span> <span style="color:#f92672">=</span><span style="color:#f92672">=</span> key <span style="color:#f92672">|</span><span style="color:#f92672">|</span> <span style="color:#f92672">(</span>key <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;</span><span style="color:#f92672">&amp;</span> key<span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>k<span style="color:#f92672">)</span><span style="color:#f92672">)</span><span style="color:#f92672">)</span><span style="color:#f92672">)</span>
                        <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
                    p <span style="color:#f92672">=</span> e<span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>e <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span> <span style="color:#75715e">// existing mapping for key
</span><span style="color:#75715e"></span>                V oldValue <span style="color:#f92672">=</span> e<span style="color:#f92672">.</span><span style="color:#a6e22e">value</span><span style="color:#f92672">;</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#f92672">!</span>onlyIfAbsent <span style="color:#f92672">|</span><span style="color:#f92672">|</span> oldValue <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span>
                    e<span style="color:#f92672">.</span><span style="color:#a6e22e">value</span> <span style="color:#f92672">=</span> value<span style="color:#f92672">;</span>
                afterNodeAccess<span style="color:#f92672">(</span>e<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
                <span style="color:#66d9ef">return</span> oldValue<span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
        <span style="color:#f92672">+</span><span style="color:#f92672">+</span>modCount<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#f92672">+</span><span style="color:#f92672">+</span>size <span style="color:#f92672">&gt;</span> threshold<span style="color:#f92672">)</span>
            resize<span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
        afterNodeInsertion<span style="color:#f92672">(</span>evict<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
</code></pre></div><p>线程A 执行完哈希碰撞检测后正好上下文切换，如果线程B 通过了哈希碰撞并且直接插入元素，那么线程A获得CPU的时候，继续执行插入会导致数据覆盖。</p>
<h2 id="死锁发生的条件">死锁发生的条件</h2>
<ul>
<li>互斥条件：一个资源每次只能被一个进程使用。</li>
<li>占有且等待：一个进程因请求资源而阻塞时，对已获得的资源保持不放。</li>
<li>不可强行占有:进程已获得的资源，在末使用完之前，不能强行剥夺。</li>
<li>循环等待条件:若干进程之间形成一种头尾相接的循环等待资源关系。</li>
</ul>
<p>这个就需要一个id值了,保护加锁的顺序是从序号小的资源开始.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Account</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">int</span> id<span style="color:#f92672">;</span>
  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">int</span> balance<span style="color:#f92672">;</span>
  <span style="color:#75715e">// 转账
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">transfer</span><span style="color:#f92672">(</span>Account target<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> amt<span style="color:#f92672">)</span><span style="color:#f92672">{</span>
    Account left <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">;</span>       <span style="color:#960050;background-color:#1e0010">①</span>
    Account right <span style="color:#f92672">=</span> target<span style="color:#f92672">;</span>    <span style="color:#960050;background-color:#1e0010">②</span>
    <span style="color:#75715e">// left是序号小的资源锁
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">id</span> <span style="color:#f92672">&gt;</span> target<span style="color:#f92672">.</span><span style="color:#a6e22e">id</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span> <span style="color:#960050;background-color:#1e0010">③</span>
      left <span style="color:#f92672">=</span> target<span style="color:#f92672">;</span>           <span style="color:#960050;background-color:#1e0010">④</span>
      right <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">;</span>            <span style="color:#960050;background-color:#1e0010">⑤</span>
    <span style="color:#f92672">}</span>                          <span style="color:#960050;background-color:#1e0010">⑥</span>
    <span style="color:#75715e">// 锁定序号小的账户
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">synchronized</span><span style="color:#f92672">(</span>left<span style="color:#f92672">)</span><span style="color:#f92672">{</span>
      <span style="color:#75715e">// 锁定序号大的账户
</span><span style="color:#75715e"></span>      <span style="color:#66d9ef">synchronized</span><span style="color:#f92672">(</span>right<span style="color:#f92672">)</span><span style="color:#f92672">{</span> 
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">balance</span> <span style="color:#f92672">&gt;</span> amt<span style="color:#f92672">)</span><span style="color:#f92672">{</span>
          <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">balance</span> <span style="color:#f92672">-</span><span style="color:#f92672">=</span> amt<span style="color:#f92672">;</span>
          target<span style="color:#f92672">.</span><span style="color:#a6e22e">balance</span> <span style="color:#f92672">+</span><span style="color:#f92672">=</span> amt<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
      <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
  <span style="color:#f92672">}</span> 
<span style="color:#f92672">}</span>
</code></pre></div><p>填水坑 O(n^2)的做法</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Solution</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">trap</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span><span style="color:#f92672">[</span><span style="color:#f92672">]</span> height<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">int</span> sum <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">for</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i<span style="color:#f92672">=</span>0<span style="color:#f92672">;</span>i<span style="color:#f92672">&lt;</span>height<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">;</span>i<span style="color:#f92672">+</span><span style="color:#f92672">+</span><span style="color:#f92672">)</span><span style="color:#f92672">{</span>
            <span style="color:#66d9ef">int</span> max_left <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span>
            <span style="color:#66d9ef">int</span> max_right <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span>
            <span style="color:#66d9ef">for</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> j <span style="color:#f92672">=</span>0<span style="color:#f92672">;</span>j<span style="color:#f92672">&lt;</span>i<span style="color:#f92672">;</span>j<span style="color:#f92672">+</span><span style="color:#f92672">+</span><span style="color:#f92672">)</span><span style="color:#f92672">{</span>
                max_left <span style="color:#f92672">=</span> Math<span style="color:#f92672">.</span><span style="color:#a6e22e">max</span><span style="color:#f92672">(</span>max_left<span style="color:#f92672">,</span>height<span style="color:#f92672">[</span>j<span style="color:#f92672">]</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
            <span style="color:#66d9ef">for</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> k <span style="color:#f92672">=</span>i<span style="color:#f92672">+</span>1<span style="color:#f92672">;</span>k<span style="color:#f92672">&lt;</span>height<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">;</span>k<span style="color:#f92672">+</span><span style="color:#f92672">+</span><span style="color:#f92672">)</span><span style="color:#f92672">{</span>
                max_right <span style="color:#f92672">=</span> Math<span style="color:#f92672">.</span><span style="color:#a6e22e">max</span><span style="color:#f92672">(</span>max_right<span style="color:#f92672">,</span>height<span style="color:#f92672">[</span>k<span style="color:#f92672">]</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
            <span style="color:#66d9ef">int</span> res <span style="color:#f92672">=</span> Math<span style="color:#f92672">.</span><span style="color:#a6e22e">min</span><span style="color:#f92672">(</span>max_right<span style="color:#f92672">,</span>max_left<span style="color:#f92672">)</span><span style="color:#f92672">;</span>

            <span style="color:#66d9ef">if</span><span style="color:#f92672">(</span>res<span style="color:#f92672">&gt;</span>height<span style="color:#f92672">[</span>i<span style="color:#f92672">]</span><span style="color:#f92672">)</span><span style="color:#f92672">{</span>
                sum <span style="color:#f92672">+</span><span style="color:#f92672">=</span> res <span style="color:#f92672">-</span> height<span style="color:#f92672">[</span>i<span style="color:#f92672">]</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">return</span> sum<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>对于一个指定位置的水坑，他所能承载的水的垂直数目取决于左右两边最高中的较小的那一块，所以通过遍历，就可以得出。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Solution</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">trap</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span><span style="color:#f92672">[</span><span style="color:#f92672">]</span> height<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">int</span> sum <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">int</span> left <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">int</span> right <span style="color:#f92672">=</span> height<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">-</span>1<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">int</span> left_max <span style="color:#f92672">=</span>0<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">int</span> right_max <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">while</span><span style="color:#f92672">(</span>left<span style="color:#f92672">&lt;</span>right<span style="color:#f92672">)</span><span style="color:#f92672">{</span>
            <span style="color:#66d9ef">if</span><span style="color:#f92672">(</span>height<span style="color:#f92672">[</span>left<span style="color:#f92672">]</span><span style="color:#f92672">&lt;</span>height<span style="color:#f92672">[</span>right<span style="color:#f92672">]</span><span style="color:#f92672">)</span><span style="color:#f92672">{</span>
                <span style="color:#66d9ef">if</span><span style="color:#f92672">(</span>height<span style="color:#f92672">[</span>left<span style="color:#f92672">]</span><span style="color:#f92672">&gt;</span>left_max<span style="color:#f92672">)</span><span style="color:#f92672">{</span>
                    left_max <span style="color:#f92672">=</span> height<span style="color:#f92672">[</span>left<span style="color:#f92672">]</span><span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>
                <span style="color:#66d9ef">else</span><span style="color:#f92672">{</span>
                    sum <span style="color:#f92672">+</span><span style="color:#f92672">=</span> left_max<span style="color:#f92672">-</span>height<span style="color:#f92672">[</span>left<span style="color:#f92672">]</span><span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>
                left<span style="color:#f92672">+</span><span style="color:#f92672">+</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
            <span style="color:#66d9ef">else</span><span style="color:#f92672">{</span>
                <span style="color:#66d9ef">if</span><span style="color:#f92672">(</span>height<span style="color:#f92672">[</span>right<span style="color:#f92672">]</span><span style="color:#f92672">&gt;</span>right_max<span style="color:#f92672">)</span><span style="color:#f92672">{</span>
                    right_max <span style="color:#f92672">=</span> height<span style="color:#f92672">[</span>right<span style="color:#f92672">]</span><span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>
                <span style="color:#66d9ef">else</span><span style="color:#f92672">{</span>
                    sum <span style="color:#f92672">+</span><span style="color:#f92672">=</span> right_max<span style="color:#f92672">-</span>height<span style="color:#f92672">[</span>right<span style="color:#f92672">]</span><span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>
                
                right<span style="color:#f92672">-</span><span style="color:#f92672">-</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">return</span> sum<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>用双指针来做，对于一个数组，我们分别定义left，right  如果height[left]&gt;height[right] 说明right决定了这个位置水的容量 如果大于最大的就跟新小于就sum++</p>
<p>上下文类加载器</p>
<p>二叉树的最小祖先</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">/**
</span><span style="color:#75715e"> * Definition for a binary tree node.
</span><span style="color:#75715e"> * public class TreeNode {
</span><span style="color:#75715e"> *     int val;
</span><span style="color:#75715e"> *     TreeNode left;
</span><span style="color:#75715e"> *     TreeNode right;
</span><span style="color:#75715e"> *     TreeNode(int x) { val = x; }
</span><span style="color:#75715e"> * }
</span><span style="color:#75715e"> */</span>
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Solution</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">public</span> TreeNode <span style="color:#a6e22e">lowestCommonAncestor</span><span style="color:#f92672">(</span>TreeNode root<span style="color:#f92672">,</span> TreeNode p<span style="color:#f92672">,</span> TreeNode q<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">if</span><span style="color:#f92672">(</span>root <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">|</span><span style="color:#f92672">|</span> p <span style="color:#f92672">=</span><span style="color:#f92672">=</span> root <span style="color:#f92672">|</span><span style="color:#f92672">|</span> q <span style="color:#f92672">=</span><span style="color:#f92672">=</span> root <span style="color:#f92672">)</span><span style="color:#f92672">{</span>
            <span style="color:#66d9ef">return</span> root<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
        TreeNode left <span style="color:#f92672">=</span> lowestCommonAncestor<span style="color:#f92672">(</span>root<span style="color:#f92672">.</span><span style="color:#a6e22e">left</span><span style="color:#f92672">,</span>p<span style="color:#f92672">,</span>q<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
        TreeNode right <span style="color:#f92672">=</span> lowestCommonAncestor<span style="color:#f92672">(</span>root<span style="color:#f92672">.</span><span style="color:#a6e22e">right</span><span style="color:#f92672">,</span>p<span style="color:#f92672">,</span>q<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">if</span><span style="color:#f92672">(</span>left<span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;</span><span style="color:#f92672">&amp;</span> right <span style="color:#f92672">!</span><span style="color:#f92672">=</span><span style="color:#66d9ef">null</span><span style="color:#f92672">)</span><span style="color:#f92672">{</span>
            <span style="color:#66d9ef">return</span> root<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">if</span><span style="color:#f92672">(</span>left <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span><span style="color:#f92672">{</span>
            <span style="color:#66d9ef">return</span> right<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span><span style="color:#66d9ef">else</span><span style="color:#f92672">{</span>
            <span style="color:#66d9ef">return</span> left<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>先查看root是不是null</p>
<p>如果root 是 pq中的其中一个节点 立马返回</p>
<p>否则遍历左子树 找到左边是否有 p 或者q</p>
<p>再遍历右子树</p>
<p>查看root 是不是符合条件</p>
<p>如果left 不存在 就返回right 让上部接住</p>
<p>right 同理</p>
<p>过一下tx 面经</p>
<p>二叉树的转链表</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Solution</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">flatten</span><span style="color:#f92672">(</span>TreeNode root<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>root <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span><span style="color:#f92672">{</span>
            <span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
        TreeNode left <span style="color:#f92672">=</span> root<span style="color:#f92672">.</span><span style="color:#a6e22e">left</span><span style="color:#f92672">;</span>
        TreeNode right <span style="color:#f92672">=</span> root<span style="color:#f92672">.</span><span style="color:#a6e22e">right</span><span style="color:#f92672">;</span>
        root<span style="color:#f92672">.</span><span style="color:#a6e22e">left</span> <span style="color:#f92672">=</span><span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
        flatten<span style="color:#f92672">(</span>left<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
        flatten<span style="color:#f92672">(</span>right<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
        TreeNode cur <span style="color:#f92672">=</span> root<span style="color:#f92672">;</span>
        root<span style="color:#f92672">.</span><span style="color:#a6e22e">right</span> <span style="color:#f92672">=</span> left<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">while</span><span style="color:#f92672">(</span>cur<span style="color:#f92672">.</span><span style="color:#a6e22e">right</span><span style="color:#f92672">!</span><span style="color:#f92672">=</span><span style="color:#66d9ef">null</span><span style="color:#f92672">)</span><span style="color:#f92672">{</span>
            cur <span style="color:#f92672">=</span> cur<span style="color:#f92672">.</span><span style="color:#a6e22e">right</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
        cur<span style="color:#f92672">.</span><span style="color:#a6e22e">right</span> <span style="color:#f92672">=</span> right<span style="color:#f92672">;</span>

    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">/**
</span><span style="color:#75715e"> * Definition for a binary tree node.
</span><span style="color:#75715e"> * public class TreeNode {
</span><span style="color:#75715e"> *     int val;
</span><span style="color:#75715e"> *     TreeNode left;
</span><span style="color:#75715e"> *     TreeNode right;
</span><span style="color:#75715e"> *     TreeNode(int x) { val = x; }
</span><span style="color:#75715e"> * }
</span><span style="color:#75715e"> */</span>
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Solution</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">private</span> TreeNode pre <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">flatten</span><span style="color:#f92672">(</span>TreeNode root<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">if</span><span style="color:#f92672">(</span>root <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span><span style="color:#f92672">{</span>
            <span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
        TreeNode left <span style="color:#f92672">=</span> root<span style="color:#f92672">.</span><span style="color:#a6e22e">left</span><span style="color:#f92672">;</span>
        TreeNode right <span style="color:#f92672">=</span> root<span style="color:#f92672">.</span><span style="color:#a6e22e">right</span><span style="color:#f92672">;</span>
        flatten<span style="color:#f92672">(</span>right<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
        flatten<span style="color:#f92672">(</span>left<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
        <span style="color:#75715e">// 先对left 赋值为null
</span><span style="color:#75715e"></span>        root<span style="color:#f92672">.</span><span style="color:#a6e22e">left</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
        <span style="color:#75715e">// 取到左边的值
</span><span style="color:#75715e"></span>        root<span style="color:#f92672">.</span><span style="color:#a6e22e">right</span> <span style="color:#f92672">=</span> pre<span style="color:#f92672">;</span>
        pre <span style="color:#f92672">=</span> root<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><h3 id="aba-问题">ABA 问题</h3>
<p>顾名思义 获取的时候是A值 然后赋值的时候也是A值，不过在中间可能因为别的线程修改成B 在转换成A  但是存在问题</p>
<p>追加版本号</p>
<ul class="pa0">
  
</ul>
<div class="mt6">
      
      
      </div>
    </section>

    <aside class="w-30-l mt6-l">




</aside>

  </article>

    </main>
    <footer class="bg-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://xiantang.github.io/" >
    &copy;  xiantang 2020 
  </a>
    <div>












</div>
  </div>
</footer>

    

  <script src="/dist/js/app.3fc0f988d21662902933.js"></script>


  </body>
</html>
